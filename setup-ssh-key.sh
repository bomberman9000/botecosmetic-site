#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

VPS_HOST="root@144.31.64.130"
PUBLIC_KEY=$(cat ~/.ssh/id_ed25519_bote.pub)

echo "üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é SSH –∫–ª—é—á –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞..."
echo ""
echo "–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:"
echo "$PUBLIC_KEY"
echo ""
echo "–ü–æ–ø—Ä–æ–±—É—é –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo "(–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å root –æ–¥–∏–Ω —Ä–∞–∑)"
echo ""

# –ü—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á —á–µ—Ä–µ–∑ ssh-copy-id
if command -v ssh-copy-id &> /dev/null; then
    ssh-copy-id -i ~/.ssh/id_ed25519_bote.pub "$VPS_HOST" 2>&1
else
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤—Ä—É—á–Ω—É—é
    echo "–î–æ–±–∞–≤–ª—è—é –∫–ª—é—á –≤—Ä—É—á–Ω—É—é..."
    ssh "$VPS_HOST" "mkdir -p ~/.ssh && chmod 700 ~/.ssh && echo '$PUBLIC_KEY' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys" 2>&1
fi

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ SSH –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
    echo ""
    echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π:"
    echo "   ./deploy-auto.sh"
else
    echo ""
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo ""
    echo "üìã –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤—Ä—É—á–Ω—É—é:"
    echo "   1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É: ssh root@144.31.64.130"
    echo "   2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "      mkdir -p ~/.ssh"
    echo "      chmod 700 ~/.ssh"
    echo "      echo '$PUBLIC_KEY' >> ~/.ssh/authorized_keys"
    echo "      chmod 600 ~/.ssh/authorized_keys"
    echo ""
    echo "–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á:"
    echo "$PUBLIC_KEY"
fi
