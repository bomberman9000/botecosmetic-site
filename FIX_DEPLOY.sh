#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –¥–µ–ø–ª–æ–µ–º
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ssh root@144.31.64.130, –∑–∞—Ç–µ–º —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã

set -e

APP_DIR="/var/www/bote-site"
cd $APP_DIR

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Node.js
echo "1. –ü—Ä–æ–≤–µ—Ä—è—é Node.js..."
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt-get install -y nodejs
else
    echo "‚úÖ Node.js: $(node --version)"
fi

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º npm
echo "2. –ü—Ä–æ–≤–µ—Ä—è—é npm..."
if ! command -v npm &> /dev/null; then
    echo "‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
else
    echo "‚úÖ npm: $(npm --version)"
fi

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2
echo "3. –ü—Ä–æ–≤–µ—Ä—è—é PM2..."
if ! command -v pm2 &> /dev/null; then
    echo "‚ùå PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    npm install -g pm2
else
    echo "‚úÖ PM2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
echo "4. –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
if [ ! -f "package.json" ]; then
    echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É."
    exit 1
fi
echo "‚úÖ –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –º–µ—Å—Ç–µ"

# 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install --production

# 6. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "6. –°–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç..."
npm run build

# 7. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "7. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—Ç–∞—Ä–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
pm2 delete bote-site 2>/dev/null || true

# 8. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "8. –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
pm2 start npm --name "bote-site" -- start

# 9. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
pm2 save

# 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 list

echo ""
echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
pm2 logs bote-site --lines 20 --nostream

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É:"
echo "   http://144.31.64.130:3001"
echo ""
echo "–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª:"
echo "   ufw allow 3001/tcp"
echo "   –∏–ª–∏"
echo "   firewall-cmd --permanent --add-port=3001/tcp && firewall-cmd --reload"



